---
layout: post
title: "MySQL ä¸­çš„ç´¢å¼•"
date: 2019-05-09T16:44:41Z
---
# MySQL ä¸­çš„ç´¢å¼• 

ç´¢å¼•ç”¨æ¥åŠ é€ŸæŸ¥è¯¢ã€‚æ­£å¸¸æ¥è¯´ï¼Œå½“æŸ¥è¯¢æ•°æ®æ—¶ï¼ŒMySQL éœ€è¦ä»è¡¨çš„ç¬¬ä¸€æ¡è®°å½•å¼€å§‹ï¼Œè¯»å–æ•´ä¸ªè¡¨çš„å†…å®¹ï¼Œè¿›è¡ŒæŸ¥è¯¢ã€‚

ä½†å¦‚æœæœ‰ç´¢å¼•ï¼ŒMySQL å¯æ ¹æ®ç´¢å¼•å¿«é€Ÿå®šä½éœ€è¦æŸ¥è¯¢æ¡ç›®çš„å…·ä½“ä½ç½®ï¼ŒåŠ å¿«äº†æŸ¥è¯¢é€Ÿåº¦ã€‚

## åŸç†

ç´¢å¼•çš„åŸç†æ˜¯å°†è¢«ç´¢å¼•åˆ—çš„å€¼ï¼Œå•ç‹¬å–å‡ºæ¥å­˜åˆ°å¦ä¸€ç§ç»“æ„ä¸­ä»¥è·å–å¿«é€ŸæŸ¥è¯¢çš„æ•ˆæœã€‚

å½“åˆ—æœ‰è¿™äº›å±æ€§ä¸­ä»»æ„ä¸€ä¸ªæ—¶ï¼Œä¼šè¢«ç´¢å¼•ï¼Œ `PRIMARY KEY`,Â `UNIQUE`,Â `INDEX`, ä»¥åŠÂ `FULLTEXT`ã€‚

å¤§éƒ¨åˆ†ç´¢å¼•ä»¥ [B-trees](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_b_tree) ç»“æ„å­˜å‚¨ã€‚ä½†æœ‰äº›ä¾‹å¤–ï¼š

- [Spatial Data æ•°æ®ç±»å‹](https://dev.mysql.com/doc/refman/8.0/en/spatial-types.html)ï¼Œä¸€ç§åŸºäºåœ°ç†åæ ‡ä½¿ç”¨æ•°å­—æ¥æ ‡è¯†ç°å®ä¸­å¯¹è±¡çš„æ•°æ®ç±»å‹ï¼Œä½¿ç”¨  [R-trees](https://en.wikipedia.org/wiki/R-tree)ã€‚
- MEMORY å†…å­˜è¡¨åŒæ—¶æ”¯æŒä½¿ç”¨ [hash ç´¢å¼•](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_hash_index) ã€‚
- InnoDB å¼•æ“ä¸­å¯¹äºå…¨æ–‡æœ¬ç´¢å¼•ï¼ˆFULLTEXTï¼‰ç›´æ¥ä½¿ç”¨åˆ—è¡¨ï¼ˆlistsï¼‰ç»“æ„ã€‚

## MySQL ä½¿ç”¨ç´¢å¼•çš„åœºæ™¯

ä»¥ä¸‹åœºæ™¯å°†å€ŸåŠ©æˆ–ä¾èµ–äºç´¢å¼•ï¼š

- ä½¿ç”¨ `WHERE` è¿›è¡Œæ¡ä»¶æŸ¥è¯¢æ—¶
- ç”¨äºæ’é™¤ä¸€äº›è®°å½•ã€‚å­˜åœ¨å¤šä¸ªç´¢å¼•å¯é€‰æ—¶ï¼ŒMySQL é€‰æ‹©ä¼šè·å–æœ€å°è®°å½•çš„é‚£ä¸ªç´¢å¼•ï¼ˆthe mostÂ [selective](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_selectivity) indexï¼‰ã€‚
- å­˜åœ¨å¤šåˆ—ç´¢å¼•çš„æƒ…å†µä¸‹ï¼Œä»å·¦æ’å¼€å§‹çš„åˆ—çš„ç»„åˆéƒ½å¯ç”¨äºæŸ¥è¯¢æ—¶çš„ä¼˜åŒ–ã€‚æ¯”å¦‚ä¸‰ä¸ªç´¢å¼•åˆ— ï¼ˆcol1, col2, col3ï¼‰ï¼ŒæŸ¥è¯¢æ—¶å¯ä»¥æœ‰è¿™äº›ç»„åˆçš„ä¼˜åŒ–æŸ¥è¯¢ (col1),Â (col1, col2), andÂ (col1, col2, col3)ï¼Œè¯¦è§ [Section 8.3.6, â€œMultiple-Column Indexesâ€](https://dev.mysql.com/doc/refman/8.0/en/multiple-column-indexes.html)ã€‚
- è”è¡¨æŸ¥è¯¢æ—¶ã€‚ç‰¹åˆ«åœ°ï¼Œå¦‚æœåˆ—çš„ç±»å‹åŠå¤§å°ç›¸åŒçš„è¯ï¼ŒæŸ¥è¯¢æ—¶ä¼šæ›´åŠ é«˜æ•ˆã€‚æ¯”å¦‚ VARCHAR å’Œ CHAR ä¼šå½“æˆåŒä¸€ç±»å‹ï¼ŒVARCHAR(10)Â andÂ CHAR(15) åˆ™ä¸æ˜¯åŒä¸€ç±»å‹ï¼Œå› ä¸ºé•¿åº¦ä¸åŒã€‚
- ä½¿ç”¨ [MIN()](https://dev.mysql.com/doc/refman/8.0/en/group-by-functions.html#function_min)ï¼Œ[MAX()](https://dev.mysql.com/doc/refman/8.0/en/group-by-functions.html#function_max) å‡½æ•°æ—¶ã€‚
- è¿›è¡Œæ’åºæˆ–åˆ†ç»„æ—¶ã€‚
- æŸäº›æƒ…å†µä¸‹ï¼Œä»…ä»…é€šè¿‡ç´¢å¼•å°±èƒ½å®ŒæˆæŸ¥è¯¢æ“ä½œï¼Œæ— é¡»æ“ä½œçœŸå®çš„è¡¨è®°å½•ã€‚è¿™ç§æä¾›äº†æŸ¥è¯¢ä¸­è¶³å¤Ÿä¿¡æ¯çš„ç´¢å¼•è¢«ç§°ä¸º [covering index](https://dev.mysql.com/doc/refman/8.0/en/glossary.html#glos_covering_index)ã€‚

ç´¢å¼•å¹¶ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œå¯¹äºæ•°æ®é‡å°çš„è¡¨ä»¥åŠå¯¹äºé‚£äº›æŸ¥è¯¢å…¨éƒ¨æ•°æ®çš„æ“ä½œï¼Œç´¢å¼•çš„æ•ˆæœå¹¶ä¸æ˜æ˜¾ã€‚ç›¸åï¼Œå¯¹äºé‚£äº›æŸ¥è¯¢æ—¶æ¶‰åŠåˆ°è¡¨ä¸­å¤§éƒ¨åˆ†æ•°æ®çš„æƒ…å†µä¸‹ï¼Œé€æ¡æŸ¥è¯¢æ¯”ä½¿ç”¨ç´¢å¼•è¦å¿«ã€‚

## ç´¢å¼•çš„ç±»å‹

ä¸»è¦æœ‰ä»¥ä¸‹å››ç§ç´¢å¼•ç±»å‹ï¼Œå…³äºåˆ›å»ºç´¢å¼•çš„å…¶ä»–è¯¦æƒ…å¯å‚è§ [MySQL Manual - 13.1.15Â CREATE INDEX Syntax](https://dev.mysql.com/doc/refman/8.0/en/create-index.html)ã€‚

- Index Prefixes
- FULLTEXT ç´¢å¼•
- Spatial ç´¢å¼•
- MEMORY Storage Engine ä¸­çš„ç´¢å¼•

### Index Prefixes

å¯¹äºå­—ç¬¦ä¸²ç±»å‹çš„åˆ—ï¼Œåœ¨ç´¢å¼•åˆ›å»ºè¯­æ³•ä¸­æŒ‡å®š `col_name(N)`ï¼Œå¯å°†è¯¥åˆ—ä¸­å‰ N ä¸ªå­—ç¬¦è¿›è¡Œç´¢å¼•ã€‚é€šè¿‡åªç´¢å¼•åˆ—ä¸­å‰ N ä¸ªå­—ç¬¦ è€Œéæ•´åˆ—ï¼Œå¯æœ‰æ•ˆå‡å°ç´¢å¼•å¤§å°ã€‚æ¯”å¦‚ç´¢å¼•  BLOB or TEXT ç±»å‹çš„åˆ—ï¼š

```sql
CREATE TABLE test (blob_col BLOB, INDEX(blob_col(10)));
```
æŸ¥è¯¢æ—¶ï¼Œå¦‚æœæŸ¥è¯¢é¡¹è¶…è¿‡äº†ç´¢å¼•é•¿åº¦ï¼Œç´¢å¼•å°†ç”¨æ¥æ’é™¤æ‰é‚£äº›åœ¨ç´¢å¼•é•¿åº¦èŒƒå›´å†…åŒ¹é…å¤±è´¥çš„è®°å½•ï¼Œå‰©ä¸‹çš„è®°å½•åˆ™æ­£å¸¸æŸ¥è¯¢ã€‚

### FULLTEXT ç´¢å¼•

å…¨æ–‡æœ¬ç´¢å¼•ç”¨äºå…¨æ–‡æœ¬ï¼ˆfull-textï¼‰çš„æœç´¢ã€‚åª [InnoDB](https://dev.mysql.com/doc/refman/8.0/en/innodb-storage-engine.html) å’Œ [MyISAM](https://dev.mysql.com/doc/refman/8.0/en/myisam-storage-engine.html) ä¸¤ç§å¼•æ“ä¸‹çš„ CHARï¼ŒVARCHARï¼ŒTEXT æ•°æ®ç±»å‹æ”¯æŒå…¨æ–‡æœ¬ç´¢å¼•ã€‚ä¸åƒ Index Prefixesï¼Œè¯¥ç±»å‹çš„ç´¢å¼•æ˜¯ä¼šå¯¹æ•´åˆ—çš„ã€‚


### Spatial ç´¢å¼•

[Spatial Data æ•°æ®ç±»å‹](https://dev.mysql.com/doc/refman/8.0/en/spatial-types.html) ä¸Šåˆ›å»ºçš„ç´¢å¼•ã€‚

### MEMORY Storage Engine ä¸­çš„ç´¢å¼•

Â MEMORYÂ å­˜å‚¨å¼•æ“é»˜è®¤ä½¿ç”¨ HASH ç´¢å¼•ï¼Œä½†ä¹Ÿæ”¯æŒ BTREE ç´¢å¼•ã€‚

## ç´¢å¼•çš„åˆ›å»º

ç´¢å¼•å¯åœ¨åˆ›å»ºè¡¨æ—¶åˆ›å»ºï¼Œå‚è€ƒ [13.1.20 CREATE TABLE Syntax](https://dev.mysql.com/doc/refman/8.0/en/create-table.html#create-table-indexes-keys)ï¼Œä¹Ÿå¯é’ˆå¯¹å·²æœ‰çš„è¡¨è¿›è¡Œåˆ›å»ºï¼Œä½¿ç”¨ [CREATE INDEX](https://dev.mysql.com/doc/refman/8.0/en/create-index.html) è¯­å¥ã€‚


<details>
<summary>
åˆ›å»ºç´¢å¼•çš„è¯­æ³•
</summary>

```sql
CREATE [UNIQUE | FULLTEXT | SPATIAL] INDEX index_name
    [index_type]
    ON tbl_name (key_part,...)
    [index_option]
    [algorithm_option | lock_option] ...

key_part: {col_name [(length)] | (expr)} [ASC | DESC]

index_option:
    KEY_BLOCK_SIZE [=] value
  | index_type
  | WITH PARSER parser_name
  | COMMENT 'string'
  | {VISIBLE | INVISIBLE}

index_type:
    USING {BTREE | HASH}

algorithm_option:
    ALGORITHM [=] {DEFAULT | INPLACE | COPY}

lock_option:
    LOCK [=] {DEFAULT | NONE | SHARED | EXCLUSIVE}
```

</details>

æœ‰å¦‚ä¸‹ç±»å‹çš„ç´¢å¼•æŒ‡å®šæ–¹å¼ï¼Œ

- ä»¥åˆ—å‰ç¼€çš„æ–¹å¼/Column Prefix Key Parts
- å‡½æ•°å½¢å¼/Functional Key Parts
- Unique ç´¢å¼•
- Full-Text ç´¢å¼•
- Spatial ç´¢å¼•

### ä»¥åˆ—å‰ç¼€çš„æ–¹å¼

å¯ç”¨äºåˆ›å»ºåˆ—ä¸­æŒ‡å®šå‰ç¼€éƒ¨åˆ† `col_name(length)` çš„ç´¢å¼•ã€‚

ç¤ºä¾‹ï¼š

```sql
CREATE INDEX part_of_name ON customer (name(10));
```

ä»¥ä¸Šè¯­å¥å¯¹åä¸º `name` çš„ä¾‹ç´¢å¼•å…¶å‰ 10 ä¸ªå­—ç¬¦ã€‚

### å‡½æ•°å½¢å¼

æ™®é€šå½¢å¼çš„ç´¢å¼•åªèƒ½ç´¢å¼•åˆ—ä¸­çš„å€¼ï¼Œæ¯”å¦‚ï¼š

```sql
CREATE TABLE t1 (
  col1 VARCHAR(10),
  col2 VARCHAR(20),
  INDEX (col1, col2(10))
);
```

ä»¥ä¸Šè¯­å¥å¯¹ `col1` æ•´åˆ— åŠ `col2` å‰ 10 ä¸ªå­—ç¬¦è¿›è¡Œç´¢å¼•ã€‚

ä½†ä½¿ç”¨å‡½æ•°å½¢å¼ï¼Œå¯åˆ›å»ºé’ˆå¯¹è¡¨è¾¾å¼çš„ç´¢å¼•ï¼Œè€Œä¸æ˜¯è¡¨ä¸­çš„åˆ—ã€‚

```sql
CREATE TABLE t1 (col1 INT, col2 INT, INDEX func_index ((ABS(col1))));
CREATE INDEX idx1 ON t1 ((col1 + col2));
CREATE INDEX idx2 ON t1 ((col1 + col2), (col1 - col2), col1);
ALTER TABLE t1 ADD INDEX ((col1 * 40) DESC);
```

å‡½æ•°å½¢å¼çš„ç´¢å¼•åœ¨å®šä¹‰æ—¶éœ€è¦æ»¡è¶³ä»¥ä¸‹çš„æ¡ä»¶ï¼Œå¦åˆ™æŠ›é”™ï¼š

- è¡¨è¾¾å¼ä½¿ç”¨æ‹¬å·åŒ…è£¹ï¼Œä»¥å’Œåˆ—åæˆ–åˆ—çš„å…¶ä»–å‰ç¼€å±æ€§åŒºåˆ«å¼€æ¥ã€‚

```sql
/* ğŸš¨ */
INDEX (col1 + col2, col3 - col4)

/* âœ… */
INDEX ((col1 + col2), (col3 - col4))
```

- å‡½æ•°å½¢å¼çš„è¡¨è¾¾å¼ä¸èƒ½å½¢æˆä¸€ä¸ªå•ç‹¬çš„åˆ—åï¼Œè­¬å¦‚ï¼š

```sql
/* ğŸš¨ */
INDEX ((col1), (col2))

/* âœ… */
INDEX (col1, col2)
```

- å‡½æ•°ä¸­ä¸èƒ½å¼•ç”¨åˆ—å‰ç¼€ï¼ˆcolumn prefixesï¼‰ã€‚
- å¤–é”®ï¼ˆforeign keyï¼‰ä¸­ä¸ä½¿ç”¨ä½¿ç”¨å‡½æ•°å½¢å¼ã€‚


### Unique ç´¢å¼•

æŒ‡å®šä¸º `UNIQUE` çš„åˆ—çº¦æŸäº†åˆ—ä¸­çš„å€¼åœ¨è®°å½•ä¸­æ˜¯å”¯ä¸€çš„ï¼Œå°è¯•æ’å…¥é‡å¤å€¼æ—¶ä¼šæŠ›é”™ã€‚ä½†å…è®¸å­˜åœ¨å¤šä¸ª NULL å€¼ï¼Œå¦‚æœè¯¥åˆ—å…è®¸ä¸ºç©ºçš„è¯ã€‚

å¦‚æœä¸€ä¸ªè¡¨æ‹¥æœ‰ `PRIMARY KEY` æˆ– `UNIQUE NOT NULL` ç±»å‹çš„å•åˆ—æ•´å‹å½¢æˆçš„ç´¢å¼•ï¼Œåœ¨ `SELECT` è¯­å¥ä¸­å¯ä½¿ç”¨ `_rowid` å…³é”®è¯æ¥è·å–ç´¢å¼•çš„åˆ—ï¼š

- å¦‚æœå­˜åœ¨ä¸€ä¸ªæ•´å‹çš„ `PRIMARY KEY` åˆ—ï¼Œ`_rowid` åˆ™æŒ‡ä»£è¯¥åˆ—ã€‚
- å¦åˆ™ `_rowid` æŒ‡ä»£ç¬¬ä¸€ä¸ª `UNIQUE NOT NULL` åˆ—ã€‚å¦‚æœä¸å­˜åœ¨ä¸€ä¸ª `UNIQUE NOT NULL` ç±»å‹çš„æ•´å‹åˆ—ï¼Œåˆ™ä¸èƒ½ä½¿ç”¨ `_rowid`ã€‚


### Full-Text ç´¢å¼•

è¯¦ç»†çš„æ“ä½œå‚è§ [12.9.7 Adding a Collation for Full-Text Indexing](https://dev.mysql.com/doc/refman/8.0/en/full-text-adding-collation.html)ã€‚


### Spatial ç´¢å¼•

ä¸åŒå­˜å‚¨å¼•æ“å¯¹å…¶æ”¯æŒæƒ…å†µä¸ä¸€ï¼Œè¯¦è§ [Spatial Indexes](https://dev.mysql.com/doc/refman/8.0/en/create-index.html#create-index-spatial)ã€‚

## ç´¢å¼•çš„æŸ¥çœ‹

é€šè¿‡å¦‚ä¸‹è¯­å¥æŸ¥çœ‹æœ‰å“ªäº›ç´¢å¼•ï¼š

```sql
SHOW INDEX FROM table_name;
```

e.g.:

ä»¥ [employees ç¤ºä¾‹æ•°æ®åº“](https://github.com/wayou/wayou.github.io/issues/82)ä¸­ titles è¡¨ä¸ºä¾‹ï¼Œå…ˆåˆ›å»ºç´¢å¼•

```sql
mysql> CREATE INDEX part_of_name ON titles (title(10));
```

æŸ¥çœ‹ç´¢å¼•

```sql
mysql> show index from titles;
+--------+------------+--------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| Table  | Non_unique | Key_name     | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment | Visible | Expression |
+--------+------------+--------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
| titles |          0 | PRIMARY      |            1 | emp_no      | A         |      300519 |     NULL |   NULL |      | BTREE      |         |               | YES     | NULL       |
| titles |          0 | PRIMARY      |            2 | title       | A         |      442783 |     NULL |   NULL |      | BTREE      |         |               | YES     | NULL       |
| titles |          0 | PRIMARY      |            3 | from_date   | A         |      442783 |     NULL |   NULL |      | BTREE      |         |               | YES     | NULL       |
| titles |          1 | part_of_name |            1 | title       | A         |           6 |       10 |   NULL |      | BTREE      |         |               | YES     | NULL       |
+--------+------------+--------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+---------+------------+
4 rows in set (0.01 sec)
```

## æŸ¥çœ‹ç´¢å¼•æ˜¯å¦å‘½ä¸­

ç´¢å¼•åˆ›å»ºåï¼Œå¯é€šè¿‡ [`explain`](https://github.com/wayou/wayou.github.io/issues/100) è¯­å¥åˆ†ææŸ¥è¯¢æ˜¯å¦å‘½ä¸­ç´¢å¼•ã€‚

```sql
mysql> EXPLAIN SELECT * FROM titles WHERE title = 'Engineer';
+----+-------------+--------+------------+------+---------------+--------------+---------+-------+--------+----------+-----------------------+
| id | select_type | table  | partitions | type | possible_keys | key          | key_len | ref   | rows   | filtered | Extra                 |
+----+-------------+--------+------------+------+---------------+--------------+---------+-------+--------+----------+-----------------------+
|  1 | SIMPLE      | titles | NULL       | ref  | part_of_name  | part_of_name | 42      | const | 221391 |   100.00 | Using index condition |
+----+-------------+--------+------------+------+---------------+--------------+---------+-------+--------+----------+-----------------------+
1 row in set, 1 warning (0.01 sec)
```

å…¶ä¸­ `possible_keys` ä¸ºå¯é€‰çš„ç´¢å¼•ï¼Œ`key` ä¸ºçœŸå®å‘½ä¸­çš„ç´¢å¼•ã€‚


## ç›¸å…³èµ„æº

- [MySQL Manual - 8.3.1 How MySQL Uses Indexes](https://dev.mysql.com/doc/refman/8.0/en/mysql-indexes.html)
- [MySQL Manual - 11.5 Spatial Data Types](https://dev.mysql.com/doc/refman/8.0/en/spatial-types.html)
- [spatial data](https://searchsqlserver.techtarget.com/definition/spatial-data)
- [MySQL Manual  - 8.3.5Â Column Indexes](https://dev.mysql.com/doc/refman/8.0/en/column-indexes.html)
- [MySQL Manual - 13.1.15Â CREATE INDEX Syntax](https://dev.mysql.com/doc/refman/8.0/en/create-index.html)

