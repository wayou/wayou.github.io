I"#§<h1 id="content-security-policy-csp-ä»‹ç»">Content Security Policy (CSP) ä»‹ç»</h1>

<p>å½“æˆ‘ä¸ç»æ„é—´åœ¨ Twitter é¡µé¢ <code class="language-plaintext highlighter-rouge">view source</code> åï¼Œå‘ç°äº†æƒŠå–œã€‚</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;title&gt;</span>Twitter<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;style&gt;</span>
  <span class="nt">body</span> <span class="p">{</span>
    <span class="nl">background-color</span><span class="p">:</span> <span class="m">#ffffff</span><span class="p">;</span>
    <span class="nl">font-family</span><span class="p">:</span> <span class="nb">sans-serif</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">a</span> <span class="p">{</span>
    <span class="nl">color</span><span class="p">:</span> <span class="m">#1da1f2</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">svg</span> <span class="p">{</span>
    <span class="nl">color</span><span class="p">:</span> <span class="m">#1da1f2</span><span class="p">;</span>
    <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>
    <span class="py">fill</span><span class="p">:</span> <span class="n">currentcolor</span><span class="p">;</span>
    <span class="nl">height</span><span class="p">:</span> <span class="m">21px</span><span class="p">;</span>
    <span class="nl">margin</span><span class="p">:</span> <span class="m">13px</span> <span class="nb">auto</span><span class="p">;</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">24px</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;noscript&gt;</span>
      
      <span class="nt">&lt;center&gt;</span>If youâ€™re not redirected soon, please <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>use this link<span class="nt">&lt;/a&gt;</span>.<span class="nt">&lt;/center&gt;</span>
    <span class="nt">&lt;/noscript&gt;</span>
    <span class="nt">&lt;script </span><span class="na">nonce=</span><span class="s">"SG0bV9rOanQfzG0ccU8WQw=="</span><span class="nt">&gt;</span>
      
      <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">app_shell_visited=1;path=/;max-age=5</span><span class="dl">"</span><span class="p">;</span>
      
      <span class="nx">location</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">"</span><span class="s2">#</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>ç›¸æ¯”å¹³æ—¶çœ‹åˆ°çš„å…¶ä»–ç«™ç‚¹çš„æºç ï¼Œå¯ä»¥è¯´æ˜¯å¾ˆæ¸…çˆ½äº†ã€‚æ²¡æœ‰ä¹±ä¸ƒå…«ç³Ÿçš„æ ‡ç­¾ï¼ŒåŠŸèƒ½å´ä¸€æ ·ä¸å°‘ã€‚ç‰¹åˆ«æœ‰è¿·æƒ‘æ€§ï¼Œä»¥ä¸ºè¿™ä¾¿æ˜¯é¡µé¢æ‰€æœ‰çš„æºç ï¼Œä½†æŸ¥çœ‹ DevTools çš„ Source é¢æ¿åå¾ˆå®¹æ˜“çŸ¥é“è¿™å¹¶ä¸æ˜¯çœŸå®çš„ HTML ä»£ç ã€‚ä½†ä¸ºä½•é¡µé¢æºç ç»™å‡ºçš„æ˜¯å¦‚æ­¤æ¸…çˆ½çš„ç‰ˆæœ¬ï¼Œè¿™é‡Œå…ˆä¸ç ”ç©¶ã€‚</p>

<p>æŠŠç›®å…‰ç§»å‘ script æ ‡ç­¾æ—¶ï¼Œå‘ç°ä¸€ä¸ªä¸è®¤è¯†çš„ <code class="language-plaintext highlighter-rouge">nonce</code> å±æ€§ã€‚å®ƒä»¥åŠå®ƒåé¢çš„ç¥ç§˜å­—ç¬¦ä¸²æˆåŠŸå¼•èµ·äº†æˆ‘çš„å¥½å¥‡ã€‚å†å»çœ‹ Google é¦–é¡µçš„æºç ï¼Œä¹Ÿæœ‰å¥½äº› <code class="language-plaintext highlighter-rouge">nonce</code> çš„è¿ç”¨ã€‚æ˜¯æ—¶å€™å»äº†è§£ä¸€ä¸‹è¿™é‡Œçš„ <code class="language-plaintext highlighter-rouge">nonce</code> æ˜¯ä»€ä¹ˆäº†ã€‚</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gs">! &lt;script nonce="SG0bV9rOanQfzG0ccU8WQw=="&gt;
</span>      
      document.cookie = "app_shell_visited=1;path=/;max-age=5";
      
      location.replace(location.href.split("#")[0]);
    &lt;/script&gt;
</code></pre></div></div>

<h3 id="content-security-policy-csp">Content Security Policy (CSP)</h3>

<p>è¦äº†è§£  <code class="language-plaintext highlighter-rouge">nonce</code>ï¼Œ å…ˆäº†è§£ <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">Content-Security-Policy(CSP)</a>ã€‚</p>

<p>æˆ‘ä»¬éƒ½çŸ¥é“æµè§ˆå™¨æœ‰åŒæºç­–ç•¥ï¼ˆ<a href="https://en.wikipedia.org/wiki/Same-origin_policy">same-origin policy</a>ï¼‰çš„å®‰å…¨é™åˆ¶ï¼Œå³æ¯ä¸ªç«™ç‚¹åªå…è®¸åŠ è½½æ¥è‡ªå’Œè‡ªèº«åŒåŸŸï¼ˆoriginï¼‰çš„æ•°æ®ï¼Œ<code class="language-plaintext highlighter-rouge">https://a.com</code> æ˜¯æ— æ³•ä» <code class="language-plaintext highlighter-rouge">https://b.com</code> åŠ è½½åˆ°èµ„æºçš„ã€‚æ¯ä¸ªç«™ç‚¹è¢«ä¸¥æ ¼é™åˆ¶åœ¨äº†è‡ªå·²çš„å­¤å²›ä¸Šï¼Œè‡ªå·±å°±æ˜¯ä¸€ä¸ªæ²™ç›’ï¼Œè¿™æ ·å¾ˆå®‰å…¨ï¼Œæ•´ä¸ªç½‘ç»œä¸ä¼šæ‚ä¹±æ— ç« ã€‚ä¸»è¦åœ°ï¼Œå®ƒèƒ½è§£å†³å¤§éƒ¨åˆ†å®‰å…¨é—®é¢˜ã€‚å‡è‹¥æ²¡æœ‰åŒæºç­–ç•¥ï¼Œæ¶æ„ä»£ç èƒ½å¤Ÿè½»æ¾åœ¨æµè§ˆå™¨ç«¯æ‰§è¡Œç„¶åè·å–å„ç§éšç§ä¿¡æ¯ï¼šé“¶è¡Œå¸å·ï¼Œç¤¾äº¤æ•°æ®ç­‰ã€‚</p>

<blockquote>
  <p>é‚£ç½‘ç«™é—´å¦‚ä½•è¿›è¡Œæ•°æ®å…±äº«ï¼Œå½“ç„¶æ˜¯æœ‰åŠæ³•çš„ï¼Œäº†è§£ä¸‹ <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS</a>ã€‚</p>
</blockquote>

<p>ç°å®ä¸­ï¼Œé—®é¢˜æ˜¯åŒæºç­–ç•¥ä¹Ÿå¹¶ä¸æ˜¯ä¸‡æ— ä¸€å¤±ï¼Œè·¨åŸŸæ”»å‡» <a href="https://en.wikipedia.org/wiki/Cross-site_scripting">Cross-site scripting (XSS)</a> ä¾¿åŒ…å«äº”èŠ±å…«é—¨ç»•å¼€é™åˆ¶çš„æ‰‹æ®µï¼Œå½¢å¼ä¸Šé€šè¿‡å‘é¡µé¢æ³¨å…¥æ¶æ„ä»£ç å®Œæˆä¿¡æ¯çš„çªƒå–æˆ–æ”»å‡»ã€‚æ¯”å¦‚ UGC ç±»å‹çš„ç«™ç‚¹ï¼Œå› ä¸ºå†…å®¹ä¾èµ–ç”¨æˆ·åˆ›å»ºï¼Œè¿™å°±å¼€äº†å¾ˆå¤§ä¸€ä¸ªå£å­ï¼Œå…è®¸ç”¨æˆ·è¾“å…¥çš„å†…å®¹è¿è¡Œåœ¨é¡µé¢ä¸Šã€‚å½“ç„¶ï¼Œå› ä¸ºæˆ‘ä»¬éƒ½çŸ¥é“ä¼šæœ‰æ³¨å…¥æ”»å‡»ï¼Œæ‰€ä»¥å¯¹ç”¨æˆ·è¾“å…¥çš„å†…å®¹è¿›è¡Œé˜² XSS è¿‡æ»¤ä¹Ÿæˆäº†æ ‡é…ã€‚</p>

<p>Content-Security-Policy ä»å¦ä¸€æ–¹é¢ç»™æµè§ˆå™¨åŠ äº†å±‚é˜²æŠ¤ï¼Œèƒ½æå¤§åœ°å‡å°‘è¿™ç§æ”»å‡»çš„å‘ç”Ÿã€‚</p>

<h3 id="åŸç†">åŸç†</h3>

<p>CSP é€šè¿‡å‘Šè¯‰æµè§ˆå™¨ä¸€ç³»åˆ—è§„åˆ™ï¼Œä¸¥æ ¼è§„å®šé¡µé¢ä¸­å“ªäº›èµ„æºå…è®¸æœ‰å“ªäº›æ¥æºï¼Œ ä¸åœ¨æŒ‡å®šèŒƒå›´å†…çš„ç»Ÿç»Ÿæ‹’ç»ã€‚ç›¸æ¯”åŒæºç­–ç•¥ï¼ŒCSP å¯ä»¥è¯´æ˜¯å¾ˆä¸¥æ ¼äº†ã€‚</p>

<p>å…¶å®æ–½æœ‰ä¸¤ç§é€”å¾„ï¼š</p>
<ul>
  <li>æœåŠ¡å™¨æ·»åŠ   <code class="language-plaintext highlighter-rouge">Content-Security-Policy</code> å“åº”å¤´æ¥æŒ‡å®šè§„åˆ™</li>
  <li>HTML ä¸­æ·»åŠ  <code class="language-plaintext highlighter-rouge">&lt;meta&gt;</code> æ ‡ç­¾æ¥æŒ‡å®š  <code class="language-plaintext highlighter-rouge">Content-Security-Policy</code> è§„åˆ™</li>
</ul>

<p><img src="https://user-images.githubusercontent.com/3783096/44004494-f3c9bdf2-9e95-11e8-8793-e2966d79ecae.png" alt="mobile.twitter.com header ä¸­çš„ CSP è§„åˆ™" />ï¿¼
<em>mobile.twitter.com header ä¸­çš„ CSP è§„åˆ™</em></p>

<p>ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œä»¥ä¸‹ç¤ºä¾‹å‡ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">&lt;meta&gt;</code> æ ‡ç­¾æ¥å¼€å¯ CSP è§„åˆ™ã€‚ä½† <code class="language-plaintext highlighter-rouge">&lt;meta&gt;</code> ä¸­æœ‰äº›æŒ‡ä»¤æ˜¯ä¸èƒ½ä½¿ç”¨çš„ï¼Œåé¢ä¼šäº†è§£åˆ°ã€‚åªæœ‰å“åº”å¤´ä¸­æ‰èƒ½ä½¿ç”¨å…¨éƒ¨çš„é™åˆ¶æŒ‡ä»¤ã€‚</p>

<h4 id="ä¸€ä¸ªç®€å•ç¤ºä¾‹">ä¸€ä¸ªç®€å•ç¤ºä¾‹</h4>

<p>åˆ›å»ºä¸€ä¸ª HTML æ–‡ä»¶æ”¾å…¥ä»¥ä¸‹å†…å®¹ï¼š</p>

<p><em>csp_test.html</em></p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"Content-Security-Policy"</span> <span class="na">content=</span><span class="s">"script-src 'self' https://unpkg.com"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>CSP Test<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://unpkg.com/react@16/umd/react.development.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>åœ¨è¯¥æµ‹è¯•æ–‡ä»¶æ‰€åœ¨ç›®å½•å¼€å¯ä¸€ä¸ªæœ¬åœ° server ä»¥è®¿é—®ï¼Œè¿™é‡Œä½¿ç”¨ Python è‡ªå¸¦çš„ server:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python <span class="nt">-m</span> SimpleHTTPServer 8000
</code></pre></div></div>

<p>ç„¶åè®¿é—® <a href="localhost:8000">localhost:8000</a> ä»¥è§‚å¯Ÿç»“æœï¼š</p>

<p><img src="https://user-images.githubusercontent.com/3783096/44004498-fdd37004-9e95-11e8-895d-53797ae105c1.png" alt="ç¬¦åˆ CSP è§„åˆ™æƒ…å†µä¸‹çš„æ­£å¸¸è®¿é—®" />ï¿¼
<em>ç¬¦åˆ CSP è§„åˆ™æƒ…å†µä¸‹çš„æ­£å¸¸è®¿é—®</em></p>

<p>ç„¶åæˆ‘ä»¬å°†  <code class="language-plaintext highlighter-rouge">Content-Security-Policy</code> æ”¹æˆä¸å…è®¸ä»»ä½•èµ„æºå†è¯•ä¸€ä¸‹ï¼š</p>

<p><em>csp_test.html</em></p>
<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
-     &lt;meta http-equiv="Content-Security-Policy" content="script-src 'self' https://unpkg.com"&gt;
</span><span class="gi">+     &lt;meta http-equiv="Content-Security-Policy" content="script-src â€˜noneâ€™"&gt;
</span>    &lt;title&gt;CSP Test&lt;/title&gt;
<span class="gd">&lt;/head&gt;
&lt;body&gt;
</span>    &lt;script src="https://unpkg.com/react@16/umd/react.development.js"&gt;&lt;/script&gt;
<span class="gd">&lt;/body&gt;
&lt;/html&gt;
</span></code></pre></div></div>

<p><img src="https://user-images.githubusercontent.com/3783096/44004501-0fac3a18-9e96-11e8-98bf-01e77f4a5e6a.png" alt="è§¦å‘ CSP è§„åˆ™èµ„æºè¢« block çš„æƒ…å†µ" />
<em>è§¦å‘ CSP è§„åˆ™èµ„æºè¢« block çš„æƒ…å†µ</em></p>

<p>ä¸‹é¢æˆ‘ä»¬æ¥è§£é‡Šè¿™é‡Œè®¾ç½®çš„ CSP è§„åˆ™åŠç†è§£ä¸ºä½•èµ„æºåŠ è½½å¤±è´¥ã€‚</p>

<h4 id="csp-è§„åˆ™">CSP è§„åˆ™</h4>

<p>æ— è®ºæ˜¯ header ä¸­è¿˜æ˜¯ <code class="language-plaintext highlighter-rouge">&lt;meta&gt;</code> æ ‡ç­¾ä¸­æŒ‡å®šï¼Œå…¶å€¼çš„æ ¼å¼éƒ½æ˜¯ç»Ÿä¸€çš„ï¼Œç”±ä¸€ç³»åˆ— CSP æŒ‡ä»¤ï¼ˆdirectiveï¼‰ç»„åˆè€Œæˆã€‚</p>

<p>ç¤ºä¾‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Content-Security-Policy: &lt;policy-directive&gt;; &lt;policy-directive&gt;â€¦
</code></pre></div></div>

<p>è¿™é‡Œ directiveï¼Œå³æŒ‡ä»¤ï¼Œæ˜¯ CSP è§„èŒƒä¸­è§„å®šç”¨ä»¥è¯¦ç»†è¯¦è¿°æŸç§èµ„æºçš„æ¥æºï¼Œæ¯”å¦‚å‰é¢ç¤ºä¾‹ä¸­ä½¿ç”¨çš„ <code class="language-plaintext highlighter-rouge">script-src</code>ï¼ŒæŒ‡å®šè„šæœ¬å¯ä»¥æœ‰å“ªäº›åˆæ³•æ¥æºï¼Œ<code class="language-plaintext highlighter-rouge">img-src</code> åˆ™æŒ‡å®šå›¾ç‰‡ï¼Œä»¥ä¸‹æ˜¯å¸¸ç”¨æŒ‡ä»¤ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">base-uri</code>Â é™åˆ¶å¯å‡ºç°åœ¨é¡µé¢ <code class="language-plaintext highlighter-rouge">&lt;base&gt;</code> æ ‡ç­¾ä¸­çš„é“¾æ¥ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">child-src</code>Â åˆ—å‡ºå¯ç”¨äº worker åŠä»¥ frame å½¢å¼åµŒå…¥çš„é“¾æ¥ã€‚ è­¬å¦‚:Â <code class="language-plaintext highlighter-rouge">child-src https://youtube.com</code>Â è¡¨ç¤ºåªèƒ½ä» Youtube åµŒå…¥è§†é¢‘èµ„æºã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">connect-src</code>Â å¯å‘èµ·è¿æ¥çš„åœ°å€ (é€šè¿‡ XHR, WebSockets æˆ– EventSource)ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">font-src</code>Â å­—ä½“æ¥æºã€‚è­¬å¦‚ï¼Œè¦ä½¿ç”¨ Google web fonts åˆ™éœ€è¦æ·»åŠ Â <code class="language-plaintext highlighter-rouge">font-src https://themes.googleusercontent.com</code> è§„åˆ™ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">form-action</code>Â <code class="language-plaintext highlighter-rouge">&lt;form&gt;</code> æ ‡ç­¾å¯æäº¤çš„åœ°å€ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">frame-ancestors</code>Â å½“å‰é¡µé¢å¯è¢«å“ªäº›æ¥æºæ‰€åµŒå…¥ï¼ˆä¸ <code class="language-plaintext highlighter-rouge">child-src</code> æ­£å¥½ç›¸åï¼‰ã€‚ä½œç”¨äºÂ <code class="language-plaintext highlighter-rouge">&lt;frame&gt;</code>,Â <code class="language-plaintext highlighter-rouge">&lt;iframe&gt;</code>,Â <code class="language-plaintext highlighter-rouge">&lt;embed&gt;</code> åŠÂ <code class="language-plaintext highlighter-rouge">&lt;applet&gt;</code>ã€‚ è¯¥æŒ‡ä»¤ä¸èƒ½é€šè¿‡ <code class="language-plaintext highlighter-rouge">&lt;meta&gt;</code> æŒ‡å®šä¸”åªå¯¹é HTMLæ–‡æ¡£ç±»å‹çš„èµ„æºç”Ÿæ•ˆã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">frame-src</code>Â è¯¥æŒ‡ä»¤å·²åœ¨ level 2 ä¸­åºŸå¼ƒä½†ä¼šåœ¨ level 3 ä¸­æ¢å¤ä½¿ç”¨ã€‚æœªæŒ‡å®šçš„æƒ…å†µä¸‹å›é€€åˆ° <code class="language-plaintext highlighter-rouge">tochild-src</code> æŒ‡ä»¤ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">img-src</code>Â æŒ‡å®šå›¾ç‰‡æ¥æºã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">media-src</code>Â é™åˆ¶éŸ³è§†é¢‘èµ„æºçš„æ¥æºã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">object-src</code>Â Flash åŠå…¶ä»–æ’ä»¶çš„æ¥æºã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">plugin-types</code>Â é™åˆ¶é¡µé¢ä¸­å¯åŠ è½½çš„æ’ä»¶ç±»å‹ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">report-uri</code> æŒ‡å®šä¸€ä¸ªå¯æ¥æ”¶ CSP æŠ¥å‘Šçš„åœ°å€ï¼Œæµè§ˆå™¨ä¼šåœ¨ç›¸åº”æŒ‡ä»¤ä¸é€šè¿‡æ—¶å‘é€æŠ¥å‘Šã€‚ä¸èƒ½é€šè¿‡ <code class="language-plaintext highlighter-rouge">&lt;meta&gt;</code> æ ‡ç­¾æ¥æŒ‡å®šã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">style-src</code>Â é™åˆ¶æ ·å¼æ–‡ä»¶çš„æ¥æºã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">upgrade-insecure-requests</code>Â æŒ‡å¯¼å®¢æˆ·ç«¯å°†é¡µé¢åœ°å€é‡å†™ï¼ŒHTTP è½¬ HTTPSã€‚ç”¨äºç«™ç‚¹ä¸­æœ‰å¤§é‡æ—§åœ°å€éœ€è¦é‡å®šå‘çš„æƒ…å½¢ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">worker-src</code> CSP Level 3 ä¸­çš„æŒ‡ä»¤ï¼Œè§„å®šå¯ç”¨äº worker, shared worker, æˆ– service worker ä¸­çš„åœ°å€ã€‚</li>
</ul>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">child-src</code>Â  ä¸ <code class="language-plaintext highlighter-rouge">frame-ancestors</code>Â  çœ‹èµ·æ¥æ¯”è¾ƒåƒã€‚å‰è€…è§„å®šçš„æ˜¯é¡µé¢ä¸­å¯åŠ è½½å“ªäº› iframeï¼Œåè€…è§„å®šè°å¯ä»¥ä»¥ iframe åŠ è½½æœ¬é¡µã€‚ æ¯”å¦‚æ¥è‡ªä¸åŒç«™ç‚¹çš„ä¸¤ä¸ªç½‘é¡µ A ä¸ Bï¼ŒB ä¸­æœ‰ iframe åŠ è½½äº† Aã€‚é‚£ä¹ˆ</p>
  <ul>
    <li>A çš„ <code class="language-plaintext highlighter-rouge">frame-ancestors</code> éœ€è¦åŒ…å« B</li>
    <li>B çš„ <code class="language-plaintext highlighter-rouge">child-src</code> éœ€è¦åŒ…å« A</li>
  </ul>
</blockquote>

<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™äº›æŒ‡ä»¤éƒ½æ˜¯æœ€å¤§æ¡ä»¶å¼€æ”¾çš„ï¼Œå¯ä»¥ç†è§£ä¸ºå…¶é»˜è®¤å€¼ä¸º <code class="language-plaintext highlighter-rouge">*</code>ã€‚æ¯”å¦‚ <code class="language-plaintext highlighter-rouge">img-src</code>ï¼Œå¦‚æœä¸æ˜ç¡®æŒ‡å®šï¼Œåˆ™å¯ä»¥ä»æ‰€æœ‰åœ°æ–¹åŠ è½½å›¾ç‰‡èµ„æºã€‚</p>

<p>è¿˜æœ‰ç§ç‰¹æ®Šçš„æŒ‡ä»¤ <code class="language-plaintext highlighter-rouge">default-src</code>ï¼Œå¦‚æœæŒ‡å®šäº†å®ƒçš„å€¼ï¼Œåˆ™ç›¸å½“äºæ”¹å˜äº†è¿™äº›æœªæŒ‡å®šçš„æŒ‡ä»¤çš„é»˜è®¤å€¼ã€‚å¯ä»¥ç†è§£ä¸ºï¼Œä¸Šé¢ <code class="language-plaintext highlighter-rouge">img-src</code> å¦‚æœæ²¡æŒ‡å®šï¼Œæœ¬æ¥å…¶é»˜è®¤å€¼æ˜¯ <code class="language-plaintext highlighter-rouge">*</code>ï¼Œå¯ä»¥åŠ è½½æ‰€æœ‰æ¥æºçš„å›¾ç‰‡ï¼Œä½†è®¾ç½® <code class="language-plaintext highlighter-rouge">default-src</code> åï¼Œé»˜è®¤å€¼å°±æˆäº† <code class="language-plaintext highlighter-rouge">default-src</code> æŒ‡å®šçš„å€¼ã€‚</p>

<p>å¸¸è§çš„åšæ³•ä¼šè®¾ç½® <code class="language-plaintext highlighter-rouge">default-src â€˜selfâ€™</code>ï¼Œè¿™æ ·æ‰€æœ‰èµ„æºéƒ½è¢«é™åˆ¶åœ¨äº†å’Œé¡µé¢åŒåŸŸä¸‹ã€‚å¦‚æœæ­¤æ—¶æƒ³è¦åŠ è½½ä» CDN æ¥çš„å›¾ç‰‡ï¼Œå°†å›¾ç‰‡æ¥æºå•ç‹¬æ·»åŠ ä¸Šå³å¯ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Content-Security-Policy: default-src â€˜selfâ€™; img-src https://cdn.example.com
</code></pre></div></div>

<p>ç°åœ¨æ¥çœ‹å¼€å¤´é‚£ä¸ªç¤ºä¾‹ï¼Œä¹Ÿè®¸ç°åœ¨å°±èƒ½çœ‹æ˜ç™½äº†ã€‚å› ä¸ºé¡µé¢ä¸­éœ€è¦ä» CDN åŠ è½½ React åº“ï¼Œæ‰€ä»¥æˆ‘ä»¬<code class="language-plaintext highlighter-rouge">&lt;meta&gt;</code> æ ‡ç­¾æŒ‡å®šäº†å¦‚ä¸‹ CSP è§„åˆ™ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>script-src 'self' https://unpkg.com
</code></pre></div></div>

<p>è¿™é‡Œçš„ <code class="language-plaintext highlighter-rouge">self</code> åŠåæ¥æ”¹æˆçš„ <code class="language-plaintext highlighter-rouge">none</code> æ˜¯é¢„è®¾å€¼ï¼Œéœ€ç”¨å¼•å·åŒ…è£¹ï¼Œå¦åˆ™ä¼šå½“æˆ URI æ¥è§£æã€‚è¿™é‡Œçš„ CSP è§„åˆ™è¡¨ç¤ºé¡µé¢ä¸­è„šæœ¬åªèƒ½ä»åŒåŸŸåŠ <code class="language-plaintext highlighter-rouge">https://unpkg.com</code> åŠ è½½ã€‚å‡å¦‚æˆ‘ä»¬æŠŠåè€…å»æ‰ï¼ŒåŒæ ·ä¼šåƒä¸Šå›¾æˆªå›¾é‚£æ · React åº“ä¼šåŠ è½½å¤±è´¥ï¼ŒåŒæ—¶æ§åˆ¶å°ä¸­ä¼šæœ‰åŠ è½½å¤±è´¥çš„æ—¥å¿—åŠè¢«è§¦å‘çš„è§„åˆ™åˆ—å‡ºæ¥ã€‚</p>

<p>æ”¹æˆ <code class="language-plaintext highlighter-rouge">none</code> ä¹‹åè¡¨ç¤ºé¡µé¢ä¸åŠ è½½ä»»ä½•è„šæœ¬ï¼Œå³ä½¿è‡ªå·±ç«™ç‚¹ä¸Šçš„è„šæœ¬éƒ½æ— æ³•è¢«åŠ è½½æ‰§è¡Œã€‚è¿™é‡Œä¸å¦¨è¯•ä¸€ä¸‹åœ¨ <code class="language-plaintext highlighter-rouge">csp_test.html</code> æ—è¾¹åˆ›å»ºä¸€ä¸ªè„šæœ¬æ–‡ä»¶ <code class="language-plaintext highlighter-rouge">test.js</code>:</p>

<p><em>test.js</em></p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">alert</span><span class="p">(</span><span class="err">â€˜</span><span class="nx">æ¥è‡ª</span> <span class="nx">test</span><span class="p">.</span><span class="nx">js</span> <span class="nx">çš„é—®å€™</span><span class="err">ï¼â€™</span><span class="p">)</span>
</code></pre></div></div>

<p>åŒæ—¶åœ¨é¡µé¢ä¸­å¼•ç”¨å®ƒï¼š</p>

<p><em>csp_test.html</em></p>
<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
</span>    &lt;meta http-equiv="Content-Security-Policy" content="script-src 'none'"&gt;
    &lt;title&gt;CSP Test&lt;/title&gt;
<span class="gd">&lt;/head&gt;
&lt;body&gt;
</span>    &lt;script src="https://unpkg.com/react@16/umd/react.development.js"&gt;&lt;/script&gt;
<span class="gi">+    &lt;script src="./test.js"&gt;&lt;/script&gt;
</span><span class="gd">&lt;/body&gt;
&lt;/html&gt;
</span></code></pre></div></div>

<p>é¡µé¢æ‰§è¡Œç»“æœï¼š</p>

<p><img src="https://user-images.githubusercontent.com/3783096/44004512-262c4df0-9e96-11e8-88e9-df4e08cb98f1.png" alt="script-src none æ—¶é¡µé¢å°†ä¸åŠ è½½ä»»ä½•è„šæœ¬" />
<em>script-src none æ—¶é¡µé¢å°†ä¸åŠ è½½ä»»ä½•è„šæœ¬</em></p>

<p>æ˜¯çš„ï¼Œå“ªæ€•æ˜¯è‡ªå·±çš„è„šæœ¬ä¹Ÿæ— æ³•è¢«åŠ è½½æ‰§è¡Œã€‚CSP å°±æ˜¯è¿™æ ·ä¸¥æ ¼å’Œæ˜ç¡®ï¼Œä¸å­˜åœ¨æ¨¡æ£±ä¸¤å¯çš„æƒ…å†µã€‚æ‰€ä»¥åœ¨æŒ‡å®šæ¥æºæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ç¡®è®¤ URI æ˜¯å¦æ­£ç¡®ã€‚</p>

<h3 id="æŒ‡ä»¤å¯æ¥å—çš„å€¼">æŒ‡ä»¤å¯æ¥å—çš„å€¼</h3>

<p>æŒ‡ä»¤åé¢è·Ÿçš„æ¥æºï¼Œæœ‰ä¸¤ç§å†™æ³•</p>
<ul>
  <li>é¢„è®¾å€¼</li>
  <li>URI é€šé…ç¬¦</li>
</ul>

<h4 id="é¢„è®¾å€¼">é¢„è®¾å€¼</h4>

<p>å…¶ä¸­é¢„è®¾å€¼æœ‰ä»¥ä¸‹è¿™äº›ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">none</code> ä¸åŒ¹é…ä»»ä½•ä¸œè¥¿ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">self</code> åŒ¹é…å½“å‰åŸŸï¼Œä½†ä¸åŒ…æ‹¬å­åŸŸã€‚æ¯”å¦‚ <code class="language-plaintext highlighter-rouge">example.com</code> å¯ä»¥ï¼Œ<code class="language-plaintext highlighter-rouge">api.example.com</code> åˆ™ä¼šåŒ¹é…å¤±è´¥ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">unsafe-inline</code>Â å…è®¸å†…åµŒçš„è„šæœ¬åŠæ ·å¼ã€‚æ˜¯çš„ï¼Œæ²¡çœ‹é”™ï¼Œå¯¹äºé¡µé¢ä¸­å†…åµŒçš„å†…å®¹ä¹Ÿæ˜¯æœ‰ç›¸åº”é™åˆ¶è§„åˆ™çš„ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">unsafe-eval</code>Â å…è®¸é€šè¿‡å­—ç¬¦ä¸²åŠ¨æ€åˆ›å»ºçš„è„šæœ¬æ‰§è¡Œï¼Œæ¯”å¦‚ <code class="language-plaintext highlighter-rouge">eval</code>ï¼Œ<code class="language-plaintext highlighter-rouge">setTimeout</code> ç­‰ã€‚</li>
</ul>

<p>ç‰¹åˆ«åœ°ï¼Œåœ¨ CSP çš„ä¸¥æ ¼æ§åˆ¶ä¸‹ï¼Œé¡µé¢ä¸­å†…è”è„šæœ¬åŠæ ·å¼ä¹Ÿä¼šå—å½±å“ï¼Œåœ¨æ²¡æœ‰æ˜ç¡®æŒ‡å®šçš„æƒ…å†µä¸‹ï¼Œå…¶ä¸èƒ½è¢«æµè§ˆå™¨æ‰§è¡Œã€‚</p>

<p>è€ƒè™‘ä¸‹é¢çš„ä»£ç ï¼š</p>

<p><em>csp_test.html</em></p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>CSP Test<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;style&gt;</span>
        <span class="nt">body</span><span class="p">{</span>
            <span class="nl">color</span><span class="p">:</span><span class="no">red</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Hello, World!<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;script&gt;</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">onload</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">hi jack!</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>
<p>ï¿¼
<img src="https://user-images.githubusercontent.com/3783096/44004521-427e59bc-9e96-11e8-9608-743f4e3bfefe.png" alt="æœªæŒ‡å®š CSP çš„æƒ…å†µ" />
<em>æœªæŒ‡å®š CSP çš„æƒ…å†µ</em></p>

<p>æ ¹æ® MDN ä¸Šçš„æè¿°ï¼Œå¦‚æœç«™ç‚¹æœªæŒ‡å®š CSP æ— åˆ™ï¼Œæµè§ˆå™¨é»˜è®¤ä¸ä¼šå¼€å¯ç›¸åº”æ£€æŸ¥ï¼Œæ‰€ä»¥ä¸Šé¢ä¸€åˆ‡è¿è¡Œæ­£å¸¸ï¼Œåªå—æ­£å¸¸çš„åŒåŸŸé™åˆ¶ ã€‚</p>

<blockquote>
  <p>If the site doesnâ€™t offer the CSPÂ header, browsers likewise use the standardÂ same-origin policy.
<em>â€” æ¥è‡ª <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP"> MDN å…³äº Content Security Policy (CSP) çš„æè¿°</a></em></p>
</blockquote>

<p>æˆ‘ä»¬åŠ ä¸Š CSP é™åˆ¶ï¼š</p>

<p><em>csp_test.html</em></p>
<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
</span><span class="gi">+    &lt;meta http-equiv="Content-Security-Policy" content="default-src 'self'"&gt;
</span>    &lt;title&gt;CSP Test&lt;/title&gt;
    &lt;style&gt;
        body{
            color:red;
        }
    &lt;/style&gt;
<span class="gd">&lt;/head&gt;
&lt;body&gt;
</span>    &lt;h1&gt;Hello, World!&lt;/h1&gt;
    &lt;script&gt;
        window.onload=function(){
            alert('hi jack!')
        }
    &lt;/script&gt;
<span class="gd">&lt;/body&gt;
&lt;/html&gt;
</span></code></pre></div></div>

<p>é…ç½®ç«™ç‚¹é»˜è®¤åªä¿¡æ¯åŒåŸŸçš„èµ„æºï¼Œä½†æ³¨æ„ï¼Œè¿™ä¸ªè®¾ç½®å¹¶ä¸åŒ…å«å†…è”çš„æƒ…å†µï¼Œæ‰€ä»¥ç»“æœä¼šå¦‚ä¸‹å›¾ã€‚</p>

<p><img src="https://user-images.githubusercontent.com/3783096/44004526-54cf1a5c-9e96-11e8-8bca-c980e51a82ae.png" alt="å†…è”ä»£ç è¢«ç¦æ­¢" />
<em>å†…è”ä»£ç è¢«ç¦æ­¢</em></p>

<p>å¦‚ä½•ä¿®å¤å®ƒå‘¢ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦å…è®¸é¡µé¢å†…çš„å†…è”è„šæœ¬æˆ–æ ·å¼ï¼Œåˆ™éœ€è¦æ˜ç¡®åœ°é€šè¿‡ <code class="language-plaintext highlighter-rouge">script-src</code> å’Œ <code class="language-plaintext highlighter-rouge">style-src</code> æŒ‡å‡ºæ¥ã€‚</p>

<p><em>csp_test.html</em></p>
<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
</span><span class="gs">!    &lt;meta http-equiv="Content-Security-Policy" content="default-src 'self' â€˜unsafe-inlineâ€™â€&gt;
</span>    &lt;title&gt;CSP Test&lt;/title&gt;
    &lt;style&gt;
        body{
            color:red;
        }
    &lt;/style&gt;
<span class="gd">&lt;/head&gt;
&lt;body&gt;
</span>    &lt;h1&gt;Hello, World!&lt;/h1&gt;
    &lt;script&gt;
        window.onload=function(){
            alert('hi jack!')
        }
    &lt;/script&gt;
<span class="gd">&lt;/body&gt;
&lt;/html&gt;
</span></code></pre></div></div>

<p>è¿™é‡Œ <code class="language-plaintext highlighter-rouge">default-src 'self' â€˜unsave-inlineâ€™</code> é…ç½®é»˜è®¤å¯ä¿¡çš„æ¥æºæœ‰è¿™äº›ï¼š å’Œé¡µé¢åŒåŸŸçš„ï¼Œä»¥åŠå†…è”çš„ã€‚</p>

<p>åˆ·æ–°é¡µé¢ï¼Œæ ·å¼åŠè„šæœ¬åˆå¯ä»¥æ­£å¸¸æ‰§è¡Œäº†ã€‚</p>

<p>é€šå¸¸æ˜¯ä¸å»ºè®®ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">unsafe-inline</code> çš„ï¼ˆåŒæ ·ä¹Ÿä¸æ¨èä½¿ç”¨ <code class="language-plaintext highlighter-rouge">unsafe-eval</code>ï¼‰ï¼Œå› ä¸ºå†…è”çš„è„šæœ¬å’Œæ ·å¼ç»´æŠ¤ä¸ä¾¿ï¼Œä¹Ÿä¸åˆ©ç”¨è‰¯å¥½åœ°ç»„ç»‡ä»£ç ã€‚æœ€ä½³å®è·µæ˜¯æ ·å¼æŠ½ç¦»åˆ°æ ·å¼æ–‡ä»¶ï¼Œè„šæœ¬æ”¾åˆ°å•ç‹¬çš„ js æ–‡ä»¶ä¸­åŠ è½½ï¼Œè®© HTML æ–‡ä»¶çº¯ç²¹ä¸€ç‚¹æ‰æ˜¯å¥½çš„åšæ³•ã€‚å³ä½¿æ˜¯ <code class="language-plaintext highlighter-rouge">onclick=â€œmyHandlerâ€</code> æˆ– <code class="language-plaintext highlighter-rouge">href=â€œjavascript:;â€</code> è¿™ç§å¹³æ—¶å¸¸è§çš„å†™æ³•ï¼Œä¹Ÿå±äºå†…è”çš„è„šæœ¬ï¼Œæ˜¯éœ€è¦æ”¹é€ çš„ã€‚</p>

<p>å¦‚æœé¡µé¢ä¸­éå¾—ç”¨å†…è”çš„å†™æ³•ï¼Œè¿˜æœ‰ç§æ–¹å¼ã€‚å³é¡µé¢ä¸­è¿™äº›å†…è”çš„è„šæœ¬æˆ–æ ·å¼æ ‡ç­¾ï¼Œèµ‹å€¼ä¸€ä¸ªåŠ å¯†ä¸²ï¼Œè¿™ä¸ªåŠ å¯†ä¸²ç”±æœåŠ¡å™¨ç”Ÿæˆï¼ŒåŒæ—¶è¿™ä¸ªåŠ å¯†ä¸²è¢«æ·»åŠ åˆ°é¡µé¢çš„å“åº”å¤´é‡Œé¢ã€‚</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">nonce=</span><span class="s">EDNnf03nceIOfn39fn3e9h3sdfa</span><span class="nt">&gt;</span>
<span class="err">Â </span> <span class="c1">// è¿™é‡Œæ”¾ç½®å†…è”åœ¨ HTML ä¸­çš„ä»£ç </span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p>é¡µé¢ HTTP å“åº”å¤´çš„ <code class="language-plaintext highlighter-rouge">Content-Security-Policy</code> é…ç½®ä¸­åŒ…å«ç›¸åŒçš„åŠ å¯†ä¸²ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Content-Security-Policy: script-src 'nonce-EDNnf03nceIOfn39fn3e9h3sdfa'
</code></pre></div></div>

<p>æ³¨æ„è¿™é‡Œçš„ <code class="language-plaintext highlighter-rouge">nonce-</code> å‰ç¼€ã€‚</p>

<p>è¿™ä¹Ÿå°±æ˜¯æ–‡ç« å¼€å¤´çœ‹åˆ°çš„æ–¹å¼ï¼Œåˆ°è¿™é‡Œæ˜ç™½äº†ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">&lt;style&gt;</code> æ ‡ç­¾ä¹Ÿæ˜¯ç±»ä¼¼çš„å¤„ç†ã€‚</p>

<p>è¿™é‡Œçš„åŠ å¯†ä¸²ä¸€å®šæ˜¯éšæœºä¸å¯é¢„æµ‹çš„ï¼Œå¦åˆ™è¾¾ä¸åˆ°å®‰å…¨æ•ˆæœï¼Œä¸”æ¯æ¬¡é¡µé¢è¢«è®¿é—®æ—¶é‡æ–°ç”Ÿæˆã€‚</p>

<p>é™¤äº†ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">noce</code> æŒ‡å®šåŠ å¯†ä¸²ï¼Œè¿˜å¯ä»¥é€šè¿‡æ··æ·†çš„ hash å€¼æ¥è¾¾åˆ°ç›®çš„ã€‚è¿™ç§åšæ³•ä¸éœ€è¦åœ¨æ ‡ç­¾ä¸ŠåŠ  <code class="language-plaintext highlighter-rouge">nonce</code> è€Œæ˜¯å°†éœ€è¦å†…åµŒçš„ä»£ç æœ¬èº«ä½¿ç”¨åŠ å¯†ç®—æ³•ç”Ÿæˆ hash åæ”¾å…¥ CSP æŒ‡ä»¤ä¸­ä½œä¸ºå€¼ä½¿ç”¨ï¼Œè¿™é‡Œçš„åŠ å¯†ç®—æ³•æ”¯æŒ sha256, sha384 å’Œ sha512ã€‚æ­¤æ—¶ CSP ä¸­ä½¿ç”¨çš„å‰ç¼€ä¸ºç›¸åº”çš„ç®—æ³•åã€‚</p>

<p>hash æ–¹å¼çš„ç¤ºä¾‹ï¼š</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span><span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">Hello, world.</span><span class="dl">'</span><span class="p">);</span><span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Content-Security-Policy: script-src 'sha256-qznLcsROx4GACP2dm0UCKCzCG-HiZ1guq6ZZDob_Tng='
</code></pre></div></div>

<h3 id="eval">eval</h3>

<p>js ä¸­å¥½äº›åœ°æ–¹æ˜¯å¯ä»¥ä»¥å­—ç¬¦ä¸²æ–¹å¼åŠ¨æ€åˆ›å»ºä»£ç å¹¶æ‰§è¡Œï¼Œè¿™è¢«è®¤ä¸ºæ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥ä¸æ¨èä½¿ç”¨ï¼Œä¸€èˆ¬æœ€ä½³å®è·µé‡Œéƒ½ä¼šæã€‚</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">setTimeout/setInterval</code> å¯æ¥æ”¶ä¸€æ®µå­—ç¬¦ä¸²ä½œä¸ºä»£ç æ‰§è¡Œã€‚<code class="language-plaintext highlighter-rouge">setTimout(â€˜alert(1)â€™,1000)</code>ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">eval</code> ã€‚<code class="language-plaintext highlighter-rouge">eval(â€˜alert(1)â€™)</code>ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">Function</code> æ„é€ å‡½æ•°ã€‚ <code class="language-plaintext highlighter-rouge">new Function(â€˜alert(1)â€™)</code>ã€‚</li>
</ul>

<p>å’Œå†…è”ä¸€æ ·ï¼Œæœ‰ä¸“é—¨çš„æŒ‡ä»¤ <code class="language-plaintext highlighter-rouge">unsafe-eval </code> ä»¥å…è®¸ç±»ä¼¼ä»£ç çš„æ‰§è¡Œã€‚ä½†å»ºè®®çš„åšæ³•æ˜¯å¯¹äº <code class="language-plaintext highlighter-rouge">eval</code> å’Œ <code class="language-plaintext highlighter-rouge">Function</code> æ„é€ å™¨ï¼Œæœç»ä½¿ç”¨ï¼Œè€Œ <code class="language-plaintext highlighter-rouge">setTimeout/setInterval</code> å¯æ”¹é€ ä¸ºéå­—ç¬¦ä¸²å½¢å¼ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">setTimout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
  <span class="nx">alert</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">},</span> <span class="mi">1000</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="uri">URI</h3>

<p>é™¤äº†ä¸Šé¢çš„é¢„è®¾å€¼ï¼Œè¿˜å¯é€šè¿‡æä¾›å®Œæ•´çš„ URI æˆ–å¸¦é€šé…ç¬¦ <code class="language-plaintext highlighter-rouge">*</code> çš„åœ°å€æ¥åŒ¹é…ï¼Œä»¥æŒ‡å®šèµ„æºçš„åˆæ³•æ¥æºã€‚è¿™é‡Œ URI çš„è§„åˆ™å’Œé…ç½®æœåŠ¡å™¨çš„è·¨åŸŸå“åº”å¤´æ˜¯ä¸€æ ·çš„ï¼Œå‚è€ƒ <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy">Same-origin policy</a>ã€‚</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">*://*.example.com:*</code> ä¼šåŒ¹é…æ‰€æœ‰ <code class="language-plaintext highlighter-rouge">example.com</code> çš„å­åŸŸåï¼Œä½†ä¸åŒ…æ‹¬ <code class="language-plaintext highlighter-rouge">example.com</code>ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">http://example.com</code> å’Œ <code class="language-plaintext highlighter-rouge">http://www.example.com</code> æ˜¯ä¸¤ä¸ªä¸åŒçš„ URIã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">http://example.com:80</code> å’Œ <code class="language-plaintext highlighter-rouge">http://example.com</code> ä¹Ÿæ˜¯æ˜¯ä¸¤ä¸ªä¸åŒçš„ URIï¼Œè™½ç„¶ç½‘ç«™é»˜è®¤ç«¯å£å°±æ˜¯ 80</li>
</ul>

<blockquote>
  <p>æ ¹æ®ç»´åŸºç™¾ç§‘ <a href="https://en.wikipedia.org/wiki/Uniform_Resource_Identifier">Uniform Resource Identifier é¡µé¢</a> ç»™å‡ºçš„è§£é‡Šï¼Œä¸€ä¸ªå®Œæ•´çš„ URI ç”±ä»¥ä¸‹éƒ¨åˆ†ç»„æˆï¼š
<code class="language-plaintext highlighter-rouge">URI = scheme:[//authority]path[?query][#fragment]</code></p>

  <p>å…¶ä¸­ <code class="language-plaintext highlighter-rouge">authority</code> åˆåŒ…å«ï¼š
<code class="language-plaintext highlighter-rouge">authority = [userinfo@]host[:port]</code></p>

  <p>æ‰€ä»¥ä½ å¯ä»¥è®¤ä¸ºå…¶ä¸­æŸä¸€é¡¹ä¸åŒï¼Œé‚£éƒ½æ˜¯ä¸¤ä¸ª URIã€‚äº†è§£è¿™ç‚¹å¾ˆé‡è¦ï¼Œä¸€å¦‚ä¸Šé¢åˆ—å‡ºçš„ç¬¬ä¸€æ¡ä¾‹å­ <code class="language-plaintext highlighter-rouge">*.example.com</code>ï¼Œ æˆ‘ä»¬å¾ˆå®¹æ˜“å…ˆå…¥ä¸ºä¸»åœ°è®¤ä¸ºæ—¢ç„¶å·²ç»å…è®¸äº†è¯¥åŸŸåçš„æ‰€æœ‰å­åŸŸåï¼Œé‚£å¿…ç„¶ <code class="language-plaintext highlighter-rouge">example.com</code> ä¹Ÿæ˜¯åˆæ³•çš„ã€‚</p>
</blockquote>

<p>å› ä¸º URI æ˜¯è¿›è¡ŒåŠ¨æ€åŒ¹é…çš„ï¼Œæ‰€ä»¥è§£é‡Šäº†ä¸Šé¢æåˆ°çš„é¢„è®¾å€¼ç¼˜ä½•è¦åŠ å¼•å·ã€‚å› ä¸ºå¦‚æœä¸åŠ å¼•å·çš„è¯ï¼Œ <code class="language-plaintext highlighter-rouge">self</code> ä¼šè¡¨ç¤º host æ˜¯ <code class="language-plaintext highlighter-rouge">self</code> çš„èµ„æºåœ°å€ï¼Œè€Œä¸ä¼šè¡¨ç¤ºåŸæœ‰çš„æ„æ€ã€‚</p>

<h4 id="ä¼˜å…ˆçº§">ä¼˜å…ˆçº§</h4>

<p>CSP çš„é…ç½®æ˜¯å¾ˆçµæ´»çš„ã€‚æ¯æ¡æŒ‡ä»¤å¯æŒ‡å®šå¤šä¸ªæ¥æºï¼Œç©ºæ ¼åˆ†å¼€ã€‚è€Œä¸€æ¡ CSP è§„åˆ™å¯ç”±å¤šæ¡æŒ‡ä»¤ç»„æˆï¼ŒæŒ‡ä»¤é—´ç”¨åˆ†å·éš”å¼€ã€‚å„æŒ‡ä»¤é—´æ²¡æœ‰é¡ºåºçš„è¦æ±‚ï¼Œå› ä¸ºæ¯æ¡æŒ‡ä»¤éƒ½æ˜¯å„å¸å…¶èŒã€‚ç”šè‡³ä¸€æ¬¡å“åº”ä¸­ï¼Œ <code class="language-plaintext highlighter-rouge">Content-Security-Policy</code> å“åº”å¤´éƒ½å¯ä»¥é‡å¤è®¾ç½®ã€‚</p>

<p>æˆ‘ä»¬æ¥çœ‹è¿™äº›æƒ…å½¢ä¸‹ CSP çš„è¡¨ç°ã€‚</p>

<ul>
  <li>å¯¹äºè®¾ç½®äº†å¤šæ¬¡å“åº”å¤´çš„æƒ…å†µï¼Œæœ€ä¸¥æ ¼çš„è§„åˆ™ä¼šç”Ÿæ•ˆã€‚æ¯”å¦‚ä¸‹é¢ä¸¤æ¡å“åº”å¤´ä¸­ï¼Œè™½ç„¶ ç¬¬äºŒæ¡ä¸­è®¾ç½® <code class="language-plaintext highlighter-rouge">connect-src</code> å…è®¸ <code class="language-plaintext highlighter-rouge">http://example.com/</code>ï¼Œä½†ç¬¬ä¸€æ¡é‡Œé¢è®¾ç½®äº† <code class="language-plaintext highlighter-rouge">connect-src</code> ä¸º <code class="language-plaintext highlighter-rouge">none</code>ï¼Œæ‰€ä»¥æ›´åŠ ä¸¥æ ¼çš„ <code class="language-plaintext highlighter-rouge">none</code> ä¼šç”Ÿæ•ˆã€‚å‚è§ <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy#Multiple_content_security_policies">Multiple content security policies</a>ã€‚</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Content-Security-Policy: default-src 'self' http://example.com;
                         connect-src 'none';
Content-Security-Policy: connect-src http://example.com/;
                         script-src http://example.com/
</code></pre></div></div>

<ul>
  <li>åŒä¸€æŒ‡ä»¤å¤šæ¬¡æŒ‡å®šï¼Œä»¥ç¬¬ä¸€ä¸ªä¸ºå‡†ï¼Œåç»­çš„ä¼šè¢«å¿½ç•¥ã€‚</li>
</ul>

<p><em>csp_test.html</em></p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"Content-Security-Policy"</span> <span class="na">content=</span><span class="s">"default-src 'self';default-src 'unsafe-inline';"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>CSP Test<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;style&gt;</span>
        <span class="nt">body</span><span class="p">{</span>
            <span class="nl">color</span><span class="p">:</span><span class="no">red</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Hello, World!<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;script&gt;</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">onload</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">hi jack!</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p><img src="https://user-images.githubusercontent.com/3783096/44004528-6a4a9f5a-9e96-11e8-88b6-6aee3342ed08.png" alt="é‡å¤é…ç½®åŒä¸€æŒ‡ä»¤æ—¶æ•ˆæœå±•ç¤º" />
<em>é‡å¤é…ç½®åŒä¸€æŒ‡ä»¤æ—¶æ•ˆæœå±•ç¤º</em></p>

<p>å¾ˆæ™ºèƒ½åœ°ï¼Œ æµè§ˆå™¨ä¸ä»…ä¼šå°†æ£€æµ‹ä¸è¿‡çš„èµ„æºåŠæŒ‡ä»¤æ‰“å°å‡ºæ¥ï¼Œé‡å¤é…ç½®æ—¶è¢«å¿½ç•¥çš„æŒ‡ä»¤ä¹Ÿä¼šæç¤ºå‡ºæ¥ã€‚</p>

<ul>
  <li>æŒ‡å®š <code class="language-plaintext highlighter-rouge">default-src</code> çš„æƒ…å†µä¸‹ï¼Œå®ƒä¼šå……å½“ <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy#Fetch_directives">Fetch ç±»æŒ‡ä»¤</a> çš„é»˜è®¤å€¼ã€‚å³  <code class="language-plaintext highlighter-rouge">default-src</code> å¹¶ä¸å¯¹æ‰€æœ‰æŒ‡ä»¤ç”Ÿæ•ˆï¼Œå…¶ä»–æŒ‡ä»¤é»˜è®¤å€¼ä»æ˜¯ <code class="language-plaintext highlighter-rouge">*</code>ã€‚</li>
</ul>

<h3 id="å‘é€æŠ¥å‘Š">å‘é€æŠ¥å‘Š</h3>

<p>å½“æ£€æµ‹åˆ°éæ³•èµ„æºæ—¶ï¼Œé™¤äº†æ§åˆ¶å°çœ‹åˆ°çš„æŠ¥é”™ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥è®©æµè§ˆå™¨å°†æ—¥å¿—å‘é€åˆ°æœåŠ¡å™¨ä»¥ä¾›åç»­åˆ†æä½¿ç”¨ã€‚æ¥æ”¶æŠ¥å‘Šçš„åœ°å€å¯åœ¨ <code class="language-plaintext highlighter-rouge">Content-Security-Policy</code> å“åº”å¤´ä¸­é€šè¿‡ <code class="language-plaintext highlighter-rouge">report-uri</code> æŒ‡ä»¤æ¥é…ç½®ã€‚å½“ç„¶ï¼ŒæœåŠ¡ç«¯éœ€è¦ç¼–å†™ç›¸åº”çš„æœåŠ¡æ¥æ¥æ”¶è¯¥æ•°æ®ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Content-Security-Policy: default-src 'self'; ...; report-uri /my_amazing_csp_report_parser;
</code></pre></div></div>

<p>æœåŠ¡ç«¯æ‹¿åˆ°çš„æ˜¯ä»¥ JSON å½¢å¼ä¼ æ¥çš„æ•°æ®ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
<span class="err">Â </span> <span class="dl">"</span><span class="s2">csp-report</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
<span class="err">Â </span> <span class="err">Â </span> <span class="dl">"</span><span class="s2">document-uri</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">http://example.org/page.html</span><span class="dl">"</span><span class="p">,</span>
<span class="err">Â </span> <span class="err">Â </span> <span class="dl">"</span><span class="s2">referrer</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">http://evil.example.com/</span><span class="dl">"</span><span class="p">,</span>
<span class="err">Â </span> <span class="err">Â </span> <span class="dl">"</span><span class="s2">blocked-uri</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">http://evil.example.com/evil.js</span><span class="dl">"</span><span class="p">,</span>
<span class="err">Â </span> <span class="err">Â </span> <span class="dl">"</span><span class="s2">violated-directive</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">script-src 'self' https://apis.google.com</span><span class="dl">"</span><span class="p">,</span>
<span class="err">Â </span> <span class="err">Â </span> <span class="dl">"</span><span class="s2">original-policy</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">script-src 'self' https://apis.google.com; report-uri http://example.org/my_amazing_csp_report_parser</span><span class="dl">"</span>
<span class="err">Â </span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="æŠ¥å‘Šæ¨¡å¼">æŠ¥å‘Šæ¨¡å¼</h3>

<p>CSP æä¾›äº†ä¸€ç§æŠ¥å‘Šæ¨¡å¼ï¼Œè¯¥æ¨¡å¼ä¸‹èµ„æºä¸ä¼šçœŸçš„è¢«é™åˆ¶åŠ è½½ï¼Œåªä¼šå¯¹æ£€æµ‹åˆ°çš„é—®é¢˜è¿›è¡Œä¸ŠæŠ¥ ï¼Œä»¥ JSON æ•°æ®çš„å½¢å¼å‘é€åˆ° <code class="language-plaintext highlighter-rouge">report-uri</code> æŒ‡å®šçš„åœ°æ–¹ã€‚</p>

<p>é€šè¿‡æŒ‡å®š <code class="language-plaintext highlighter-rouge">Content-Security-Policy-Report-Only</code> è€Œä¸æ˜¯ <code class="language-plaintext highlighter-rouge">Content-Security-Policy</code>ï¼Œåˆ™å¼€å¯äº†æŠ¥å‘Šæ¨¡å¼ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Content-Security-Policy-Report-Only: default-src 'self'; ...; report-uri /my_amazing_csp_report_parser;
</code></pre></div></div>

<p>å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥åŒæ—¶æŒ‡å®šä¸¤ç§å“åº”å¤´ï¼Œå„è‡ªé‡Œçš„è§„åˆ™è¿˜ä¼šæ­£å¸¸æ‰§è¡Œï¼Œä¸ä¼šäº’ç›¸å½±å“ã€‚æ¯”å¦‚ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Content-Security-Policy: img-src *;
Content-Security-Policy-Report-Only: img-src â€˜noneâ€™; report-uri http://reportcollector.example.com/collector.cgi
</code></pre></div></div>

<p>è¿™é‡Œå›¾ç‰‡è¿˜æ˜¯ä¼šæ­£å¸¸åŠ è½½ï¼Œä½†æ˜¯ <code class="language-plaintext highlighter-rouge">img-src â€˜noneâ€™</code> ä¹Ÿä¼šæ£€æµ‹åˆ°å¹¶ä¸”å‘é€æŠ¥å‘Šã€‚</p>

<p>æŠ¥å‘Šæ¨¡å¼å¯¹äºæµ‹è¯•éå¸¸æœ‰ç”¨ã€‚åœ¨å¼€å¯ CSP ä¹‹å‰è‚¯å®šéœ€è¦å¯¹æ•´ç«™åšå…¨é¢çš„æµ‹è¯•ï¼Œå°†å‘ç°çš„é—®é¢˜åŠæ—¶ä¿®å¤åå†çœŸæ­£å¼€å¯ï¼Œæ¯”å¦‚ä¸Šé¢æåˆ°çš„å¯¹å†…è”ä»£ç çš„æ”¹é€ ã€‚</p>

<h3 id="æ¨èçš„åšæ³•">æ¨èçš„åšæ³•</h3>

<p>è¿™æ ·çš„å®‰å…¨æªæ–½å½“ç„¶æ˜¯èƒ½å°½å¿«å¯ç”¨å°±å°½å¿«ã€‚ä»¥ä¸‹æ˜¯æ¨èçš„åšæ³•ï¼š</p>
<ul>
  <li>å…ˆåªå¼€å¯æŠ¥å‘Šæ¨¡å¼ï¼Œçœ‹å½±å“èŒƒå›´ï¼Œä¿®æ”¹é—®é¢˜ã€‚</li>
  <li>æ·»åŠ æŒ‡ä»¤æ—¶ä» default-src â€˜noneâ€™ å¼€å§‹ï¼ŒæŸ¥çœ‹æŠ¥é”™ï¼Œé€æ­¥æ·»åŠ è§„åˆ™ç›´è‡³æ»¡è¶³è¦æ±‚ã€‚</li>
  <li>ä¸Šçº¿åè§‚å¯Ÿä¸€æ®µæ—¶é—´ï¼Œç¨³å®šåå†ç”±æŠ¥å‘Šæ¨¡å¼è½¬åˆ°å¼ºåˆ¶æ‰§è¡Œã€‚</li>
</ul>

<h3 id="æµè§ˆå™¨å…¼å®¹æ€§">æµè§ˆå™¨å…¼å®¹æ€§</h3>

<p>ç›®å‰å‘å¸ƒçš„<a href="https://www.w3.org/TR/CSP3/"> Level 3 è§„èŒƒ</a> ä¸­å¤§éƒ¨åˆ†è¿˜æœªè¢«æµè§ˆå™¨å®ç°ï¼Œé€šè¿‡  <a href="https://caniuse.com/#search=CSP">Can I Use çš„æ•°æ®</a> æ¥çœ‹ï¼Œé™¤ IE å¤–ï¼ŒLevel 2 çš„åŠŸèƒ½å·²ç»å¾—åˆ°äº†å¾ˆå¥½çš„æ”¯æŒã€‚è¿™é‡Œè¿˜æœ‰ä¸€åˆ†æ¥è‡ª W3C è·Ÿè¸ªçš„å„æµè§ˆå™¨å®ç°æƒ…å†µçš„ç»Ÿè®¡ï¼š<a href="https://w3c.github.io/webappsec/implementation_reports/CSP2_implementation_report.html">Implementation Report for Content Security Policy Level 2</a>ã€‚</p>

<p>å¯¹äºæµè§ˆå™¨ä¸æ”¯æŒçš„æƒ…å†µï¼Œä¹Ÿä¸å¿…æ‹…å¿ƒï¼Œä¼šå›é€€åˆ°åŒæºç­–ç•¥çš„é™åˆ¶ä¸Šã€‚</p>

<h3 id="ç›¸å…³èµ„æº">ç›¸å…³èµ„æº</h3>

<ul>
  <li><a href="https://security.stackexchange.com/questions/8264/why-is-the-same-origin-policy-so-important">Why is the same origin policy so important?</a></li>
  <li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">Content Security Policy (CSP)</a></li>
  <li><a href="https://developers.google.com/web/fundamentals/security/csp/">Content Security Policy from Web Fundamentals</a></li>
  <li><a href="https://blog.twitter.com/engineering/en_us/a/2011/improving-browser-security-with-csp.html">Improving Browser Security with CSP</a></li>
</ul>

:ET