I"ª/<h1 id="koa-ä¸­çš„é”™è¯¯å¤„ç†">koa ä¸­çš„é”™è¯¯å¤„ç†</h1>

<p>ä¸åƒ express ä¸­åœ¨æœ«å°¾å¤„æ³¨å†Œä¸€ä¸ªå£°æ˜ä¸º <code class="language-plaintext highlighter-rouge">(err, req, res, next)</code> ä¸­é—´ä»¶çš„æ–¹å¼ï¼Œkoa åˆšå¥½ç›¸åï¼Œåœ¨å¼€å¤´è¿›è¡Œæ³¨å†Œã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">async</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">status</span> <span class="o">||</span> <span class="mi">500</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">"</span><span class="s2">error</span><span class="dl">"</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<p>è¿™æ ·ç¨‹åºä¸­ä»»ä½•æŠ¥é”™éƒ½ä¼šæ”¶æ•›åˆ°æ­¤å¤„ã€‚æ­¤æ—¶å¯ä»¥æ–¹ä¾¿åœ°å°†é”™è¯¯æ‰“å°åˆ°é¡µé¢ï¼Œå¼€å‘æ—¶éå¸¸ä¾¿æ·ã€‚</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gi">+     ctx.app.emit('error', err, ctx);
</span></code></pre></div></div>

<p>koa ä¹Ÿå»ºè®®é€šè¿‡ app æ¥æ´¾å‘é”™è¯¯ï¼Œç„¶åé€šè¿‡ç›‘å¬ app ä¸Šçš„ <code class="language-plaintext highlighter-rouge">error</code> äº‹ä»¶å¯¹è¿™äº›é”™è¯¯åšè¿›ä¸€æ­¥çš„ç»Ÿä¸€å¤„ç†å’Œé›†ä¸­ç®¡ç†ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">error</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="cm">/* é”™è¯¯çš„é›†ä¸­å¤„ç†:
   *  log å‡ºæ¥
   *  å†™å…¥æ—¥å¿—
   *  å†™å…¥æ•°æ®åº“
   *   ...
   */</span>
<span class="p">});</span>
</code></pre></div></div>

<p>ä¸€ä¸ªé”™è¯¯æ•è·å¹¶æ‰“å°åˆ°é¡µé¢çš„ç¤ºä¾‹ï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Koa</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">koa</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Koa</span><span class="p">();</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">async</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">next</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">status</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">status</span> <span class="o">||</span> <span class="mi">500</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">status</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">html</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s2">`
    &lt;b&gt;</span><span class="p">${</span><span class="nx">status</span><span class="p">}</span><span class="s2">&lt;/b&gt; </span><span class="p">${</span><span class="nx">err</span><span class="p">}</span><span class="s2">
    `</span><span class="p">;</span>
    <span class="c1">// emmit</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="dl">"</span><span class="s2">error</span><span class="dl">"</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">hello</span><span class="dl">"</span><span class="p">;</span>
  <span class="nx">a</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">hello world!</span><span class="dl">"</span><span class="p">;</span> <span class="c1">// TypeError: Assignment to constant variable.</span>
  <span class="nx">ctx</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">a</span><span class="p">;</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">error</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Ooops..</span><span class="se">\n</span><span class="dl">"</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</code></pre></div></div>

<p>é€šè¿‡ <code class="language-plaintext highlighter-rouge">node server.js</code> å¯åŠ¨åè®¿é—®é¡µé¢å¯çœ‹åˆ°å‘½ä»¤è¡Œçš„é”™è¯¯è¾“å‡ºã€‚
å¦‚æœä½¿ç”¨ pm2ï¼Œå¯é€šè¿‡ <code class="language-plaintext highlighter-rouge">â€”no-daemon</code> å‚æ•°ä½¿å…¶åœç•™åœ¨åœ¨å‘½ä»¤è¡Œä»¥æŸ¥çœ‹è¾“å‡ºã€‚
å¦‚æœä¸ä½¿ç”¨ä¸Šè¿°å‚æ•°ï¼Œå¯é€šè¿‡ <code class="language-plaintext highlighter-rouge">pm2 logs [app-name]</code> æ¥æŸ¥çœ‹ã€‚</p>

<h3 id="ctxthrow"><code class="language-plaintext highlighter-rouge">ctx.throw</code></h3>

<p>æœ´ç´ çš„æŠ›é”™æ–¹å¼éœ€è¦æ‰‹åŠ¨è®¾ç½®çŠ¶æ€ç åŠä¿¡æ¯å¯¹å®¢æˆ·ç«¯çš„å¯è§æ€§ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">err msg</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">err</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="mi">401</span><span class="p">;</span>
<span class="nx">err</span><span class="p">.</span><span class="nx">expose</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">expose</code> å†³å®šæ˜¯å¦ä¼šè¿”å›é”™è¯¯è¯¦æƒ…ç»™å®¢æˆ·ç«¯ï¼Œå¦åˆ™åªå±•ç¤ºçŠ¶æ€å¯¹åº”çš„é”™è¯¯æ–‡æ¡ˆï¼Œæ¯”å¦‚ 500 ä¼šåœ¨æµè§ˆå™¨ä¸­å±•ç¤ºä¸º <code class="language-plaintext highlighter-rouge">Internal Server Error</code>ã€‚</p>

<p>è€Œé€šè¿‡ <a href="https://github.com/koajs/koa/blob/master/docs/api/context.md#ctxthrowstatus-msg-properties"><code class="language-plaintext highlighter-rouge">ctx.throw</code></a> è¿™ä¸ª helper æ–¹æ³•ä¼šæ›´åŠ ç®€æ´ã€‚
ä¸Šé¢çš„ä»£ç ç‰‡æ®µç­‰ä»·äº:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">ctx</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="dl">"</span><span class="s2">err msg</span><span class="dl">"</span><span class="p">);</span>
</code></pre></div></div>

<p>å¦‚æœä¸æŒ‡å®šçŠ¶æ€ç ï¼Œé»˜è®¤ä¸º 500ã€‚5xx ç±»é”™è¯¯ <code class="language-plaintext highlighter-rouge">expose</code> é»˜è®¤ä¸º <code class="language-plaintext highlighter-rouge">false</code>ï¼Œå³ä¸ä¼šå°†é”™è¯¯ä¿¡æ¯è¿”å›åˆ° responseã€‚</p>

<p>æŠ›é”™æ—¶è¿˜å¯ä»¥ä¼ é€’ä¸€äº›é¢å¤–æ•°æ®ï¼Œè¿™äº›æ•°æ®ä¼šåˆå¹¶åˆ°é”™è¯¯å¯¹è±¡ä¸Šï¼Œåœ¨å¤„ç†é”™è¯¯çš„åœ°æ–¹å¯ä»¥ä» <code class="language-plaintext highlighter-rouge">error</code> ä¸Šè·å–ã€‚</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">ctx</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="dl">"</span><span class="s2">access_denied</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">user</span><span class="p">:</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">foo</span><span class="dl">"</span> <span class="p">}</span> <span class="p">});</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">error</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Ooops..</span><span class="se">\n</span><span class="dl">"</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">user</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="å‚è€ƒ">å‚è€ƒ</h3>

<ul>
  <li><a href="https://github.com/koajs/koa/wiki/Error-Handling">Error Handling</a></li>
  <li><a href="https://github.com/koajs/koa/blob/master/docs/api/context.md#ctxthrowstatus-msg-properties"><code class="language-plaintext highlighter-rouge">ctx.throw</code></a></li>
</ul>

:ET